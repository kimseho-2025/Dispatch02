<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>성우 배차 관리 시스템</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="description" content="실시간 배차 현황 관리 및 조회 시스템">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="성우배차">

    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: pan-y pinch-zoom;
            -webkit-overflow-scrolling: touch;
            /* Overscroll 제어: 페이지 바운스 방지 */
            overscroll-behavior-y: none;
            overscroll-behavior-x: auto;
        }

        /* 드로어 또는 모달 열렸을 때 body 스크롤 차단 */
        body.drawer-open,
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .mobile-table-container {
            touch-action: pan-x pan-y;
            -webkit-overflow-scrolling: touch;
            /* 테이블 스크롤이 body로 전파되지 않도록 */
            overscroll-behavior: contain;
        }

        .modal-content {
            touch-action: pan-y;
            /* 모달 내부 스크롤 격리 */
            overscroll-behavior: contain;
        }

        /* 드로어 메뉴 스크롤 격리 */
        .mobile-drawer {
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
       
        .modal-backdrop {
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
       
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
       
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
       
        .modal-content {
            animation: slideUp 0.3s ease-out;
        }
       
        .cell-preview {
            min-height: 100px;
            transition: all 0.2s;
            position: relative;
        }
       
        .cell-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
       
        .cell-preview.has-content {
            background: linear-gradient(to bottom, #f0fdf4, #dcfce7);
            border-color: #86efac;
        }
       
        .status-scheduled {
            background: linear-gradient(to right, #dbeafe, #bfdbfe);
            color: #1e40af;
            border-color: #3b82f6;
        }
        
        .status-confirmed {
            background: linear-gradient(to right, #fed7aa, #fdba74);
            color: #9a3412;
            border-color: #f97316;
        }
        
        .status-completed {
            background: linear-gradient(to right, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #10b981;
        }
       
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            margin: 4px;
            background: linear-gradient(to right, #dbeafe, #bfdbfe);
            color: #1e40af;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.15s;
            cursor: pointer;
        }
       
        .chip:hover {
            background: linear-gradient(to right, #bfdbfe, #93c5fd);
            transform: scale(1.05);
        }
       
        .chip button {
            margin-left: 8px;
            color: #ef4444;
            font-weight: 900;
            transition: all 0.15s;
        }
       
        .chip button:hover {
            color: #dc2626;
            transform: scale(1.2);
        }
       
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            z-index: 9999;
        }
       
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .mobile-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 12px rgba(0,0,0,0.15);
            transition: right 0.3s ease-out;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .mobile-drawer.open {
            right: 0;
        }
        
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
            z-index: 999;
        }
        
        .drawer-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .header-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
        }
        
        .header-content.compact {
            max-height: 0;
            opacity: 0;
        }

        .focus-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }
        
        .focus-view-content {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        .range-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .range-input input {
            width: 60px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .mobile-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                /* 좌우 스크롤 snap 효과 (1열씩 이동) */
                scroll-snap-type: x mandatory;
                scroll-padding: 0;
                scrollbar-width: none; /* Firefox */
            }

            .mobile-table-container::-webkit-scrollbar {
                display: none; /* Chrome, Safari */
            }

            /* 1열씩 이동 가능한 snap (모든 열이 snap 포인트) */
            .mobile-table th,
            .mobile-table td {
                min-width: 30vw; /* 화면의 약 1/3 크기로 3열 표시 */
                font-size: 0.8rem;
                padding: 0.5rem;
                /* 모든 열에 snap 적용 = 1칸씩 이동 가능 */
                scroll-snap-align: start;
            }

            .mobile-table .cell-preview {
                min-height: 80px;
                padding: 0.5rem;
            }

            .toast {
                bottom: 12px;
                right: 12px;
                padding: 12px 16px;
                font-size: 0.875rem;
            }

            .modal-content {
                margin-bottom: 20px;
            }

            #pivotModal .modal-content > div:last-child {
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawer()"></div>
    
    <div id="mobileDrawer" class="mobile-drawer">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-gray-800">메뉴</h2>
                <button onclick="closeDrawer()" class="text-2xl text-gray-600 hover:text-gray-800">×</button>
            </div>
            
            <div class="space-y-3">
                <button onclick="showSearchModal(); closeDrawer();" class="w-full p-3 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    검색
                </button>
               
                <button onclick="showExportModal(); closeDrawer();" class="w-full p-3 bg-green-100 hover:bg-green-200 text-green-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    내보내기
                </button>
               
                <button onclick="showVehicleModal(); closeDrawer();" class="w-full p-3 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    차량설정
                </button>
                
                <button onclick="showAccessLog(); closeDrawer();" class="w-full p-3 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    접속 로그
                </button>
                
                <button onclick="showBugReport(); closeDrawer();" class="w-full p-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    버그 리포트
                </button>
               
                <button onclick="showWriterModal(); closeDrawer();" class="w-full p-3 bg-blue-100 hover:bg-blue-200 rounded-xl transition text-sm flex items-center gap-2">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="font-bold text-blue-700" id="writerNameMobile">미인증</span>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-3 md:p-6">
        <header id="mainHeader" class="bg-white shadow-2xl rounded-2xl p-3 md:p-5 mb-5 sticky top-3 z-50">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2 md:gap-3">
                    <button onclick="toggleHeader()" class="p-2 hover:bg-gray-100 rounded-lg md:hidden">
                        <svg id="headerToggleIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-2 md:p-3 rounded-xl">
                        <svg class="w-6 h-6 md:w-8 md:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg md:text-3xl font-black text-gray-800">성우 배차</h1>
                        <p class="text-xs text-gray-500 hidden md:block">실시간 배차 현황</p>
                    </div>
                </div>
               
                <div class="flex items-center gap-2">
                    <div class="hidden lg:flex items-center gap-2">
                        <button onclick="showSearchModal()" class="px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            검색
                        </button>
                       
                        <button onclick="showExportModal()" class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            내보내기
                        </button>
                       
                        <button onclick="showVehicleModal()" class="px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            차량
                        </button>
                        
                        <button onclick="showAccessLog()" class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            로그
                        </button>
                        
                        <button onclick="showBugReport()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl font-bold transition text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            리포트
                        </button>
                       
                        <button onclick="showWriterModal()" class="px-4 py-2 bg-blue-100 hover:bg-blue-200 rounded-xl transition text-sm flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span class="font-bold text-blue-700" id="writerName">미인증</span>
                        </button>
                    </div>
                    
                    <button onclick="openDrawer()" class="lg:hidden p-2 hover:bg-gray-100 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
           
            <div id="headerContent" class="header-content">
                <div class="mt-4 flex flex-wrap items-center justify-center gap-2 md:gap-3">
                    <button onclick="navigateWeek(-1)" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold transition flex items-center gap-1 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="hidden md:inline">이전 주</span>
                    </button>
                   
                    <div class="text-center px-3 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200">
                        <div class="text-sm md:text-lg font-black text-gray-800" id="weekDisplay"></div>
                        <div class="text-xs text-gray-600 font-semibold" id="weekRange"></div>
                    </div>
                   
                    <button onclick="navigateWeek(1)" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold transition flex items-center gap-1 text-sm">
                        <span class="hidden md:inline">다음 주</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                   
                    <button onclick="goToToday()" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-xl font-bold transition shadow-lg text-sm">
                        오늘
                    </button>
                   
                    <input type="week" id="weekPicker" onchange="changeWeek(this.value)"
                           class="px-2 py-2 border-2 border-gray-300 rounded-xl text-xs md:text-sm font-semibold focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition">
                </div>
            </div>
        </header>

        <div class="flex gap-3 mb-5">
            <button onclick="showPage('view')" id="btnView" class="flex-1 py-3 md:py-4 rounded-xl font-black text-base md:text-lg transition shadow-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                배차 현황
            </button>
            <button onclick="showPage('input')" id="btnInput" class="flex-1 py-3 md:py-4 rounded-xl font-black text-base md:text-lg transition bg-gray-200 text-gray-700">
                배차 입력
            </button>
        </div>

        <section id="viewPage" class="bg-white rounded-2xl shadow-2xl overflow-hidden mobile-table-container">
            <div class="overflow-x-auto">
                <table class="w-full border-collapse mobile-table">
                    <thead class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white sticky top-0">
                        <tr>
                            <th colspan="7" class="py-3 md:py-4 text-center font-black text-lg md:text-xl">
                                주간 배차 현황
                            </th>
                        </tr>
                        <tr class="bg-gradient-to-r from-blue-400 to-indigo-500">
                            <th id="vday0" class="p-2 md:p-3 border-r border-blue-300 min-w-[100px] text-xs md:text-sm"></th>
                            <th id="vday1" class="p-2 md:p-3 border-r border-blue-300 min-w-[100px] text-xs md:text-sm"></th>
                            <th id="vday2" class="p-2 md:p-3 border-r border-blue-300 min-w-[100px] text-xs md:text-sm"></th>
                            <th id="vday3" class="p-2 md:p-3 border-r border-blue-300 min-w-[100px] text-xs md:text-sm"></th>
                            <th id="vday4" class="p-2 md:p-3 border-r border-blue-300 min-w-[100px] text-xs md:text-sm"></th>
                            <th id="vday5" class="p-2 md:p-3 border-r border-blue-300 min-w-[100px] text-xs md:text-sm"></th>
                            <th id="vday6" class="p-2 md:p-3 min-w-[100px] text-xs md:text-sm"></th>
                        </tr>
                    </thead>
                    <tbody id="viewTableBody"></tbody>
                </table>
            </div>
        </section>

        <section id="inputPage" class="hidden">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mb-5">
                <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-4 md:p-5">
                    <h3 class="text-white font-black text-base md:text-lg mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        특정 날짜에 배차 정보 입력
                    </h3>
                    <div class="flex flex-wrap gap-3">
                        <input type="date" id="specificDate" class="flex-1 min-w-[180px] px-3 py-2 md:px-4 md:py-3 rounded-xl border-2 border-white font-semibold focus:ring-4 focus:ring-green-200 text-sm md:text-base">
                        <button onclick="openPivotModalForDate()" class="px-4 py-2 md:px-6 md:py-3 bg-white text-green-600 hover:bg-green-50 rounded-xl font-bold transition shadow-md text-sm md:text-base">
                            이 날짜에 입력하기
                        </button>
                    </div>
                </div>
               
                <div class="overflow-x-auto mobile-table-container">
                    <table class="w-full border-collapse mobile-table">
                        <thead class="bg-gradient-to-r from-green-500 to-emerald-600 text-white sticky top-0">
                            <tr>
                                <th colspan="7" class="py-3 md:py-4 text-center font-black text-lg md:text-xl">
                                    주간 배차 입력
                                </th>
                            </tr>
                            <tr class="bg-gradient-to-r from-green-400 to-emerald-500">
                                <th id="day0" class="p-2 md:p-3 border-r border-green-300 min-w-[100px] text-xs md:text-sm"></th>
                                <th id="day1" class="p-2 md:p-3 border-r border-green-300 min-w-[100px] text-xs md:text-sm"></th>
                                <th id="day2" class="p-2 md:p-3 border-r border-green-300 min-w-[100px] text-xs md:text-sm"></th>
                                <th id="day3" class="p-2 md:p-3 border-r border-green-300 min-w-[100px] text-xs md:text-sm"></th>
                                <th id="day4" class="p-2 md:p-3 border-r border-green-300 min-w-[100px] text-xs md:text-sm"></th>
                                <th id="day5" class="p-2 md:p-3 border-r border-green-300 min-w-[100px] text-xs md:text-sm"></th>
                                <th id="day6" class="p-2 md:p-3 min-w-[100px] text-xs md:text-sm"></th>
                            </tr>
                        </thead>
                        <tbody id="inputTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 피벗 입력 모달 -->
        <div id="pivotModal" class="fixed inset-0 bg-black bg-opacity-60 modal-backdrop hidden items-center justify-center z-50 p-3">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto modal-content">
                <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 md:p-6 rounded-t-3xl z-10">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl md:text-2xl font-black flex items-center gap-2 md:gap-3">
                            <svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            배차 정보 입력
                        </h3>
                        <button onclick="closePivotModal()" class="text-2xl md:text-3xl hover:text-gray-200 transition hover:rotate-90 duration-300">×</button>
                    </div>
                </div>
               
                <div class="p-4 md:p-6 grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <div class="space-y-4 md:space-y-5">
                        <div class="bg-yellow-50 p-3 md:p-4 rounded-2xl border-2 border-yellow-200">
                            <label class="block font-black text-gray-800 mb-2 text-sm md:text-base">날짜 변경</label>
                            <input type="date" id="pivotDate" class="w-full p-2 md:p-3 border-2 border-yellow-300 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-200 transition font-semibold text-sm md:text-base">
                        </div>

                        <div class="bg-purple-50 p-3 md:p-4 rounded-2xl border-2 border-purple-200">
                            <label class="block font-black text-gray-800 mb-2 text-sm md:text-base">배차 상태</label>
                            <select id="pivotStatus" class="w-full p-2 md:p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-200 transition font-semibold text-sm md:text-base">
                                <option value="SCHEDULED">예정</option>
                                <option value="CONFIRMED">확정</option>
                                <option value="COMPLETED">완료</option>
                            </select>
                        </div>

                        <div class="bg-blue-50 p-3 md:p-4 rounded-2xl border-2 border-blue-200">
                            <label class="block font-black text-gray-800 mb-2 text-sm md:text-base">
                                업체명 <span class="text-red-500">*필수</span>
                            </label>
                            <input type="text" id="pivotCompany" placeholder="예: 정도철강"
                                   class="w-full p-2 md:p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-200 transition font-semibold text-sm md:text-base"
                                   oninput="updatePivotPreview()">
                            <button onclick="saveCompanyToList()" class="text-xs md:text-sm text-blue-600 hover:text-blue-800 mt-2 font-bold">
                                + 목록에 저장 (최대 10개)
                            </button>
                            <div id="companiesChips" class="mt-3"></div>
                        </div>
                       
                        <div class="bg-green-50 p-3 md:p-4 rounded-2xl border-2 border-green-200">
                            <label class="block font-black text-gray-800 mb-2 text-sm md:text-base">상차지</label>
                            <input type="text" id="pivotLoading" placeholder="예: 남양주"
                                   class="w-full p-2 md:p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-200 transition font-semibold text-sm md:text-base"
                                   oninput="updatePivotPreview()">
                            <button onclick="saveLoadingToList()" class="text-xs md:text-sm text-green-600 hover:text-green-800 mt-2 font-bold">
                                + 목록에 저장 (최대 10개)
                            </button>
                            <div id="loadingsChips" class="mt-3"></div>
                        </div>
                       
                        <div class="bg-pink-50 p-3 md:p-4 rounded-2xl border-2 border-pink-200">
                            <label class="block font-black text-gray-800 mb-2 text-sm md:text-base">연락처</label>
                            <input type="tel" id="pivotContact" placeholder="010-1234-5678"
                                   class="w-full p-2 md:p-3 border-2 border-pink-300 rounded-xl focus:border-pink-500 focus:ring-4 focus:ring-pink-200 transition font-semibold text-sm md:text-base">
                        </div>
                       
                        <div class="bg-amber-50 p-3 md:p-4 rounded-2xl border-2 border-amber-200">
                            <label class="block font-black text-gray-800 mb-2 text-sm md:text-base">특이사항</label>
                            <textarea id="pivotNotes" placeholder="급배송, 주의사항 등"
                                      rows="3"
                                      class="w-full p-2 md:p-3 border-2 border-amber-300 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-200 transition resize-none font-semibold text-sm md:text-base"></textarea>
                        </div>
                    </div>
                   
                    <div class="space-y-4 md:space-y-5">
                        <div class="bg-purple-50 p-3 md:p-4 rounded-2xl border-2 border-purple-200">
                            <label class="block font-black text-gray-800 mb-3 text-sm md:text-base">시간 (수기 입력)</label>
                            <input type="text" id="pivotTimeInput" placeholder="예: 오후 2시, 14:00, 새벽 5시" 
                                   class="w-full p-2 md:p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-200 transition font-semibold text-sm md:text-base"
                                   oninput="updatePivotPreview()">
                        </div>
                       
                        <div class="bg-orange-50 p-3 md:p-4 rounded-2xl border-2 border-orange-200">
                            <label class="block font-black text-gray-800 mb-2 text-xs md:text-sm">방통차 배차</label>
                            <div class="flex gap-2 mb-2">
                                <button onclick="setBangMode('single')" id="bangModeSingle" class="flex-1 py-2 px-3 bg-white border-2 border-orange-300 rounded-lg text-xs font-bold">단일</button>
                                <button onclick="setBangMode('range')" id="bangModeRange" class="flex-1 py-2 px-3 bg-orange-200 border-2 border-orange-300 rounded-lg text-xs font-bold">범위</button>
                            </div>
                            <div id="bangSingleInput">
                                <select id="bangSelect" onchange="selectPivot('bang', this.value)" class="w-full p-2 border-2 border-orange-300 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition font-semibold text-xs md:text-sm">
                                    <option value="">선택안함</option>
                                </select>
                            </div>
                            <div id="bangRangeInput" class="hidden">
                                <div class="range-input">
                                    <input type="number" id="bangMin" min="1" max="20" placeholder="최소" class="p-2 border-2 border-orange-300 rounded-lg text-xs" oninput="updateBangRange()">
                                    <span class="text-lg font-bold">~</span>
                                    <input type="number" id="bangMax" min="1" max="20" placeholder="최대" class="p-2 border-2 border-orange-300 rounded-lg text-xs" oninput="updateBangRange()">
                                    <span class="text-xs font-semibold">대</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-cyan-50 p-3 md:p-4 rounded-2xl border-2 border-cyan-200">
                            <label class="block font-black text-gray-800 mb-2 text-xs md:text-sm">집게차 배차</label>
                            <div class="flex gap-2 mb-2">
                                <button onclick="setJipMode('single')" id="jipModeSingle" class="flex-1 py-2 px-3 bg-white border-2 border-cyan-300 rounded-lg text-xs font-bold">단일</button>
                                <button onclick="setJipMode('range')" id="jipModeRange" class="flex-1 py-2 px-3 bg-cyan-200 border-2 border-cyan-300 rounded-lg text-xs font-bold">범위</button>
                            </div>
                            <div id="jipSingleInput">
                                <select id="jipSelect" onchange="selectPivot('jip', this.value)" class="w-full p-2 border-2 border-cyan-300 rounded-xl focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 transition font-semibold text-xs md:text-sm">
                                    <option value="">선택안함</option>
                                </select>
                            </div>
                            <div id="jipRangeInput" class="hidden">
                                <div class="range-input">
                                    <input type="number" id="jipMin" min="1" max="10" placeholder="최소" class="p-2 border-2 border-cyan-300 rounded-lg text-xs" oninput="updateJipRange()">
                                    <span class="text-lg font-bold">~</span>
                                    <input type="number" id="jipMax" min="1" max="10" placeholder="최대" class="p-2 border-2 border-cyan-300 rounded-lg text-xs" oninput="updateJipRange()">
                                    <span class="text-xs font-semibold">대</span>
                                </div>
                            </div>
                        </div>
                       
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 md:p-5 rounded-2xl border-2 border-gray-300">
                            <p class="font-black text-gray-800 mb-3 text-base md:text-lg">미리보기</p>
                            <div id="previewContent" class="text-xs md:text-sm space-y-2"></div>
                        </div>
                       
                        <button onclick="applyAndSave()"
                                class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-black py-3 md:py-4 rounded-2xl shadow-2xl transition transform hover:scale-[1.02] text-base md:text-lg">
                            저장하기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Focus View 모달 -->
        <div id="focusView" class="focus-view hidden">
            <div class="focus-view-content">
                <div id="focusViewHeader" class="p-4 rounded-t-2xl"></div>
                <div id="focusViewBody" class="p-6"></div>
                <div class="p-4 border-t">
                    <button onclick="closeFocusView()" class="w-full py-3 bg-gray-200 hover:bg-gray-300 rounded-xl font-bold transition">
                        닫기
                    </button>
                </div>
            </div>
        </div>

        <!-- 작성자 인증 모달 -->
        <div id="writerModal" class="fixed inset-0 bg-black bg-opacity-60 modal-backdrop hidden items-center justify-center z-50 p-3">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md modal-content">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 md:p-6 rounded-t-3xl">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl md:text-2xl font-black">작성자 인증</h3>
                        <button onclick="closeWriterModal()" class="text-2xl md:text-3xl hover:text-gray-200 transition">×</button>
                    </div>
                </div>
               
                <div class="p-4 md:p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-black text-gray-700 mb-2">이름</label>
                        <input type="text" id="writerNameInput" placeholder="홍길동"
                               class="w-full p-3 md:p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-200 transition font-semibold text-sm md:text-base">
                    </div>
                   
                    <div>
                        <label class="block text-sm font-black text-gray-700 mb-2">비밀번호 (4자리 숫자)</label>
                        <input type="password" id="writerPassInput" placeholder="1234" maxlength="4"
                               class="w-full p-3 md:p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-200 transition font-semibold text-sm md:text-base"
                               onkeypress="if(event.key==='Enter') saveWriter()">
                    </div>
                   
                    <button onclick="saveWriter()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-black py-3 rounded-xl transition shadow-lg">
                        인증하기
                    </button>
                   
                    <button onclick="logout()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl transition">
                        로그아웃
                    </button>
                </div>
            </div>
        </div>

        <!-- 검색 모달 -->
        <div id="searchModal" class="fixed inset-0 bg-black bg-opacity-60 modal-backdrop hidden items-center justify-center z-50 p-3">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
                <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 md:p-6 rounded-t-3xl z-10">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl md:text-2xl font-black">배차 검색</h3>
                        <button onclick="closeSearchModal()" class="text-2xl md:text-3xl hover:text-gray-200 transition">×</button>
                    </div>
                </div>
               
                <div class="p-4 md:p-6 space-y-4">
                    <div>
                        <label class="block font-black text-gray-800 mb-2 text-sm md:text-base">검색어</label>
                        <input type="text" id="searchInput" placeholder="업체명, 상차지, 작성자 등..."
                               class="w-full p-3 md:p-4 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-200 transition font-semibold text-sm md:text-base"
                               oninput="performSearch()">
                    </div>
                   
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">시작일</label>
                            <input type="date" id="searchStartDate"
                                   class="w-full p-2 md:p-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition font-semibold text-sm"
                                   onchange="performSearch()">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">종료일</label>
                            <input type="date" id="searchEndDate"
                                   class="w-full p-2 md:p-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition font-semibold text-sm"
                                   onchange="performSearch()">
                        </div>
                    </div>
                   
                    <div id="searchResults" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- 내보내기 모달 -->
        <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-60 modal-backdrop hidden items-center justify-center z-50 p-3">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md modal-content">
                <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-4 md:p-6 rounded-t-3xl">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl md:text-2xl font-black">데이터 내보내기</h3>
                        <button onclick="closeExportModal()" class="text-2xl md:text-3xl hover:text-gray-200 transition">×</button>
                    </div>
                </div>
               
                <div class="p-4 md:p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">시작일</label>
                            <input type="date" id="exportStartDate"
                                   class="w-full p-2 md:p-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-200 transition font-semibold text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">종료일</label>
                            <input type="date" id="exportEndDate"
                                   class="w-full p-2 md:p-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-200 transition font-semibold text-sm">
                        </div>
                    </div>
                   
                    <button onclick="exportToCSV()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-black py-3 rounded-xl transition shadow-lg text-sm md:text-base">
                        CSV 파일로 내보내기
                    </button>
                   
                    <button onclick="exportToExcel()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-black py-3 rounded-xl transition shadow-lg text-sm md:text-base">
                        Excel 파일로 내보내기
                    </button>
                </div>
            </div>
        </div>

        <!-- 차량 설정 모달 -->
        <div id="vehicleModal" class="fixed inset-0 bg-black bg-opacity-60 modal-backdrop hidden items-center justify-center z-50 p-3">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md modal-content">
                <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-4 md:p-6 rounded-t-3xl">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl md:text-2xl font-black">차량 대수 설정</h3>
                        <button onclick="closeVehicleModal()" class="text-2xl md:text-3xl hover:text-gray-200 transition">×</button>
                    </div>
                </div>
               
                <div class="p-4 md:p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-black text-gray-700 mb-2">방통차 대수 (1-20)</label>
                        <input type="number" id="bangCountInput" min="1" max="20" value="5"
                               class="w-full p-3 md:p-4 border-2 border-gray-300 rounded-xl focus:border-orange-500 focus:ring-4 focus:ring-orange-200 transition font-semibold text-base md:text-lg">
                    </div>
                   
                    <div>
                        <label class="block text-sm font-black text-gray-700 mb-2">집게차 대수 (1-10)</label>
                        <input type="number" id="jipCountInput" min="1" max="10" value="3"
                               class="w-full p-3 md:p-4 border-2 border-gray-300 rounded-xl focus:border-cyan-500 focus:ring-4 focus:ring-cyan-200 transition font-semibold text-base md:text-lg">
                    </div>
                   
                    <button onclick="saveVehicleCount()" class="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-black py-3 rounded-xl transition shadow-lg">
                        저장하기
                    </button>
                </div>
            </div>
        </div>

        <div id="toast" class="hidden"></div>
    </div>

    <script>
// ==================== 전역 변수 선언 ====================
const DB_NAME = 'dispatchDB';
const STORE_NAME = 'weekly_reports';
const LOG_STORE = 'access_logs';
const ERROR_STORE = 'error_logs';
const DAYS = ['일', '월', '화', '수', '목', '금', '토'];
const DEFAULT_ROWS = 8;
const MAX_COMPANIES = 10;
const MAX_LOADINGS = 10;
const MAX_LOGS = 50;

let db = null;
let currentWeekStart = '';
let writer = { name: '미인증', pin: '' };
let currentRow = -1;
let currentCol = -1;

let COMPANIES = JSON.parse(localStorage.getItem('companyList') || '[]');
let LOADINGS = JSON.parse(localStorage.getItem('loadingList') || '[]');

let pivotSelection = {
    company: '', loading: '', time: '', bang: '', jip: '',
    contact: '', notes: '', date: '', status: 'SCHEDULED'
};

let bangMode = 'single';
let jipMode = 'single';
let lastScrollY = 0;
let scrollTicking = false;
let scrollDebounceTimer = null;

const STATUS_MAP = {
    SCHEDULED: { name: '예정', class: 'status-scheduled', color: 'bg-blue-100 text-blue-700' },
    CONFIRMED: { name: '확정', class: 'status-confirmed', color: 'bg-orange-100 text-orange-700' },
    COMPLETED: { name: '완료', class: 'status-completed', color: 'bg-green-100 text-green-700' }
};

// ==================== IndexedDB 초기화 ====================
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 3);

        request.onerror = () => {
            console.error('❌ IndexedDB 열기 실패:', request.error);
            logError('DB Open Failed', request.error);
            reject(request.error);
        };

        request.onsuccess = () => {
            db = request.result;
            console.log('✅ IndexedDB 연결 성공');
            resolve(db);
        };

        request.onupgradeneeded = (event) => {
            const database = event.target.result;

            if (!database.objectStoreNames.contains(STORE_NAME)) {
                const store = database.createObjectStore(STORE_NAME, { keyPath: 'weekStart' });
                store.createIndex('weekStart', 'weekStart', { unique: true });
                console.log('✅ Object Store 생성됨:', STORE_NAME);
            }

            if (!database.objectStoreNames.contains(LOG_STORE)) {
                const logStore = database.createObjectStore(LOG_STORE, { keyPath: 'id', autoIncrement: true });
                logStore.createIndex('timestamp', 'timestamp', { unique: false });
                console.log('✅ Log Store 생성됨');
            }

            if (!database.objectStoreNames.contains(ERROR_STORE)) {
                const errorStore = database.createObjectStore(ERROR_STORE, { keyPath: 'id', autoIncrement: true });
                errorStore.createIndex('timestamp', 'timestamp', { unique: false });
                console.log('✅ Error Store 생성됨');
            }
        };
    });
}

// ==================== 데이터 조회 함수 ====================
function getAllReports() {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject(new Error('DB가 초기화되지 않았습니다'));
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();

        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
    });
}

function getWeekReport(weekStart) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject(new Error('DB가 초기화되지 않았습니다'));
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(weekStart);

        request.onsuccess = () => {
            if (request.result) {
                resolve(request.result);
            } else {
                const emptyReport = createEmptyWeekReport(weekStart);
                resolve(emptyReport);
            }
        };

        request.onerror = () => reject(request.error);
    });
}

function createEmptyWeekReport(weekStart) {
    const report = {
        weekStart: weekStart,
        rows: []
    };

    const dates = [];
    const start = new Date(weekStart);
    for (let i = 0; i < 7; i++) {
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        dates.push(date.toISOString().split('T')[0]);
    }

    for (let r = 0; r < DEFAULT_ROWS; r++) {
        const row = {};
        dates.forEach(date => {
            row[date] = {
                company: '',
                loading: '',
                time: '',
                bang: '',
                jip: '',
                contact: '',
                notes: '',
                writer: '',
                timestamp: '',
                status: 'SCHEDULED'
            };
        });
        report.rows.push(row);
    }

    return report;
}

// ==================== 데이터 저장 함수 ====================
function saveWeekReport(weekStart, rows) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject(new Error('DB가 초기화되지 않았습니다'));
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.put({ weekStart, rows });

        request.onsuccess = () => {
            console.log('✅ 주간 리포트 저장 성공:', weekStart);
            resolve();
        };

        request.onerror = () => {
            console.error('❌ 저장 실패:', request.error);
            reject(request.error);
        };
    });
}

function deleteReport(weekStart) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject(new Error('DB가 초기화되지 않았습니다'));
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(weekStart);

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

// ==================== 로그 관리 함수 ====================
function logAccess(action, details = '') {
    if (!db) return Promise.resolve();

    return new Promise((resolve) => {
        const transaction = db.transaction([LOG_STORE], 'readwrite');
        const store = transaction.objectStore(LOG_STORE);

        const log = {
            timestamp: new Date().toISOString(),
            writer: writer.name,
            action: action,
            details: details
        };

        store.add(log);

        const countRequest = store.count();
        countRequest.onsuccess = () => {
            if (countRequest.result > MAX_LOGS) {
                const cursorRequest = store.openCursor();
                cursorRequest.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        cursor.delete();
                    }
                };
            }
        };

        transaction.oncomplete = () => resolve();
        transaction.onerror = () => resolve();
    });
}

function logError(action, error) {
    if (!db) return Promise.resolve();

    return new Promise((resolve) => {
        const transaction = db.transaction([ERROR_STORE], 'readwrite');
        const store = transaction.objectStore(ERROR_STORE);

        const errorLog = {
            timestamp: new Date().toISOString(),
            writer: writer.name,
            action: action,
            error: error.toString()
        };

        store.add(errorLog);

        transaction.oncomplete = () => resolve();
        transaction.onerror = () => resolve();
    });
}

function getAccessLogs() {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject(new Error('DB가 초기화되지 않았습니다'));
            return;
        }

        const transaction = db.transaction([LOG_STORE], 'readonly');
        const store = transaction.objectStore(LOG_STORE);
        const request = store.getAll();

        request.onsuccess = () => {
            const logs = request.result || [];
            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            resolve(logs);
        };

        request.onerror = () => reject(request.error);
    });
}

function getErrorLogs() {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject(new Error('DB가 초기화되지 않았습니다'));
            return;
        }

        const transaction = db.transaction([ERROR_STORE], 'readonly');
        const store = transaction.objectStore(ERROR_STORE);
        const request = store.getAll();

        request.onsuccess = () => {
            const logs = request.result || [];
            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            resolve(logs);
        };

        request.onerror = () => reject(request.error);
    });
}

// ==================== 날짜 처리 함수 ====================
function getWeekStartDate(date = new Date()) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day;
    d.setDate(diff);
    return d.toISOString().split('T')[0];
}

function formatDateDisplay(dateStr) {
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const dayName = DAYS[date.getDay()];
    return `${month}/${day} (${dayName})`;
}

function parseDate(dateStr) {
    return new Date(dateStr + 'T00:00:00');
}

function getWeekRange(weekStart) {
    const start = new Date(weekStart);
    const end = new Date(weekStart);
    end.setDate(start.getDate() + 6);

    return `${start.getMonth() + 1}/${start.getDate()} ~ ${end.getMonth() + 1}/${end.getDate()}`;
}

// ==================== 주간 네비게이션 함수 ====================
function navigateWeek(offset) {
    const current = new Date(currentWeekStart);
    current.setDate(current.getDate() + (offset * 7));
    currentWeekStart = getWeekStartDate(current);

    updateWeekDisplay();
    loadAndRenderWeek();
    logAccess('Navigate Week', currentWeekStart);
}

function changeWeek(weekValue) {
    if (!weekValue) return;

    const [year, week] = weekValue.split('-W');
    const date = new Date(year, 0, 1 + (week - 1) * 7);
    const day = date.getDay();
    const diff = date.getDate() - day;
    date.setDate(diff);

    currentWeekStart = getWeekStartDate(date);
    updateWeekDisplay();
    loadAndRenderWeek();
    logAccess('Change Week', currentWeekStart);
}

function goToToday() {
    currentWeekStart = getWeekStartDate(new Date());
    updateWeekDisplay();
    loadAndRenderWeek();
    logAccess('Go To Today');
}

function updateWeekDisplay() {
    const weekDisplay = document.getElementById('weekDisplay');
    const weekRange = document.getElementById('weekRange');
    const weekPicker = document.getElementById('weekPicker');

    if (weekDisplay) {
        const start = new Date(currentWeekStart);
        const weekNum = getWeekNumber(start);
        weekDisplay.textContent = `${start.getFullYear()}년 ${weekNum}주차`;
    }

    if (weekRange) {
        weekRange.textContent = getWeekRange(currentWeekStart);
    }

    if (weekPicker) {
        const start = new Date(currentWeekStart);
        const year = start.getFullYear();
        const weekNum = getWeekNumber(start);
        weekPicker.value = `${year}-W${String(weekNum).padStart(2, '0')}`;
    }
}

function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// ==================== 페이지 전환 함수 ====================
function showPage(page) {
    const viewPage = document.getElementById('viewPage');
    const inputPage = document.getElementById('inputPage');
    const btnView = document.getElementById('btnView');
    const btnInput = document.getElementById('btnInput');

    if (page === 'view') {
        viewPage.classList.remove('hidden');
        inputPage.classList.add('hidden');
        btnView.className = 'flex-1 py-3 md:py-4 rounded-xl font-black text-base md:text-lg transition shadow-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white';
        btnInput.className = 'flex-1 py-3 md:py-4 rounded-xl font-black text-base md:text-lg transition bg-gray-200 text-gray-700';
        logAccess('View Page');
    } else {
        viewPage.classList.add('hidden');
        inputPage.classList.remove('hidden');
        btnView.className = 'flex-1 py-3 md:py-4 rounded-xl font-black text-base md:text-lg transition bg-gray-200 text-gray-700';
        btnInput.className = 'flex-1 py-3 md:py-4 rounded-xl font-black text-base md:text-lg transition shadow-lg bg-gradient-to-r from-green-500 to-emerald-600 text-white';
        logAccess('Input Page');
    }
}

// ==================== 테이블 렌더링 함수 ====================
async function loadAndRenderWeek() {
    try {
        const report = await getWeekReport(currentWeekStart);
        renderViewTable(report);
        renderInputTable(report);
    } catch (error) {
        console.error('❌ 주간 리포트 로드 실패:', error);
        logError('Load Week Report', error);
        showToast('데이터 로드 실패');
    }
}

function renderViewTable(report) {
    const tbody = document.getElementById('viewTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    const dates = [];
    const start = new Date(report.weekStart);
    for (let i = 0; i < 7; i++) {
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        dates.push(date.toISOString().split('T')[0]);

        const th = document.getElementById(`vday${i}`);
        if (th) {
            th.textContent = formatDateDisplay(date.toISOString().split('T')[0]);

            const today = new Date().toISOString().split('T')[0];
            if (date.toISOString().split('T')[0] === today) {
                th.classList.add('bg-yellow-300', 'text-yellow-900');
            } else {
                th.classList.remove('bg-yellow-300', 'text-yellow-900');
            }
        }
    }

    for (let r = 0; r < report.rows.length; r++) {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-200 hover:bg-blue-50 transition';

        for (let c = 0; c < 7; c++) {
            const date = dates[c];
            const cell = report.rows[r][date] || {};
            const td = document.createElement('td');
            td.className = 'p-2 md:p-3 border-r border-gray-200 cell-preview cursor-pointer';

            if (cell.company || cell.loading || cell.time || cell.bang || cell.jip) {
                td.classList.add('has-content');

                if (cell.status && STATUS_MAP[cell.status]) {
                    td.classList.add(STATUS_MAP[cell.status].class);
                }

                let html = '<div class="space-y-1 text-xs md:text-sm">';
                if (cell.company) html += `<div class="font-black text-gray-800">${cell.company}</div>`;
                if (cell.loading) html += `<div class="text-gray-600">📍 ${cell.loading}</div>`;
                if (cell.time) html += `<div class="text-blue-600">🕐 ${cell.time}</div>`;

                const vehicles = [];
                if (cell.bang) vehicles.push(cell.bang);
                if (cell.jip) vehicles.push(cell.jip);
                if (vehicles.length > 0) {
                    html += `<div class="text-green-600 font-bold">🚛 ${vehicles.join(' / ')}</div>`;
                }

                if (cell.contact) html += `<div class="text-purple-600">📞 ${cell.contact}</div>`;
                if (cell.notes) html += `<div class="text-orange-600">📝 ${cell.notes}</div>`;
                if (cell.writer) html += `<div class="text-gray-500 text-xs mt-2">✍️ ${cell.writer}</div>`;

                html += '</div>';
                td.innerHTML = html;
            } else {
                td.innerHTML = '<div class="text-gray-300 text-center text-xs">-</div>';
            }

            td.onclick = () => openCellFocusView(r, c, date, cell);
            tr.appendChild(td);
        }

        tbody.appendChild(tr);
    }
}

function renderInputTable(report) {
    const tbody = document.getElementById('inputTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    const dates = [];
    const start = new Date(report.weekStart);
    for (let i = 0; i < 7; i++) {
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        dates.push(date.toISOString().split('T')[0]);

        const th = document.getElementById(`day${i}`);
        if (th) {
            th.textContent = formatDateDisplay(date.toISOString().split('T')[0]);

            const today = new Date().toISOString().split('T')[0];
            if (date.toISOString().split('T')[0] === today) {
                th.classList.add('bg-yellow-300', 'text-yellow-900');
            } else {
                th.classList.remove('bg-yellow-300', 'text-yellow-900');
            }
        }
    }

    for (let r = 0; r < report.rows.length; r++) {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-200 hover:bg-green-50 transition';

        for (let c = 0; c < 7; c++) {
            const date = dates[c];
            const cell = report.rows[r][date] || {};
            const td = document.createElement('td');
            td.className = 'p-2 md:p-3 border-r border-gray-200 cell-preview cursor-pointer';

            if (cell.company || cell.loading || cell.time || cell.bang || cell.jip) {
                td.classList.add('has-content');

                if (cell.status && STATUS_MAP[cell.status]) {
                    td.classList.add(STATUS_MAP[cell.status].class);
                }

                let html = '<div class="space-y-1 text-xs md:text-sm">';
                if (cell.company) html += `<div class="font-black text-gray-800">${cell.company}</div>`;
                if (cell.loading) html += `<div class="text-gray-600">📍 ${cell.loading}</div>`;
                if (cell.time) html += `<div class="text-blue-600">🕐 ${cell.time}</div>`;

                const vehicles = [];
                if (cell.bang) vehicles.push(cell.bang);
                if (cell.jip) vehicles.push(cell.jip);
                if (vehicles.length > 0) {
                    html += `<div class="text-green-600 font-bold">🚛 ${vehicles.join(' / ')}</div>`;
                }

                if (cell.contact) html += `<div class="text-purple-600">📞 ${cell.contact}</div>`;
                if (cell.notes) html += `<div class="text-orange-600">📝 ${cell.notes}</div>`;
                if (cell.writer) html += `<div class="text-gray-500 text-xs mt-2">✍️ ${cell.writer}</div>`;

                html += '</div>';
                td.innerHTML = html;
            } else {
                td.innerHTML = '<div class="text-gray-300 text-center text-xs">빈 셀<br>클릭하여 입력</div>';
            }

            td.onclick = () => openPivotModal(r, c, date);
            tr.appendChild(td);
        }

        tbody.appendChild(tr);
    }
}

// ==================== 셀 포커스 뷰 ====================
function openCellFocusView(row, col, date, cell) {
    const focusView = document.getElementById('focusView');
    const header = document.getElementById('focusViewHeader');
    const body = document.getElementById('focusViewBody');

    if (!focusView || !header || !body) return;

    let statusClass = 'bg-gradient-to-r from-blue-600 to-indigo-700';
    if (cell.status === 'CONFIRMED') {
        statusClass = 'bg-gradient-to-r from-orange-600 to-red-700';
    } else if (cell.status === 'COMPLETED') {
        statusClass = 'bg-gradient-to-r from-green-600 to-emerald-700';
    }

    header.className = `p-4 rounded-t-2xl text-white ${statusClass}`;
    header.innerHTML = `
        <div class="font-black text-xl">${formatDateDisplay(date)}</div>
        <div class="text-sm opacity-90">${STATUS_MAP[cell.status]?.name || '예정'}</div>
    `;

    let bodyHtml = '<div class="space-y-4">';

    if (cell.company) {
        bodyHtml += `
            <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                <div class="text-xs text-gray-600 mb-1">업체명</div>
                <div class="font-black text-lg text-gray-800">${cell.company}</div>
            </div>
        `;
    }

    if (cell.loading) {
        bodyHtml += `
            <div class="bg-green-50 p-4 rounded-xl border-2 border-green-200">
                <div class="text-xs text-gray-600 mb-1">상차지</div>
                <div class="font-bold text-gray-800">📍 ${cell.loading}</div>
            </div>
        `;
    }

    if (cell.time) {
        bodyHtml += `
            <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                <div class="text-xs text-gray-600 mb-1">시간</div>
                <div class="font-bold text-gray-800">🕐 ${cell.time}</div>
            </div>
        `;
    }

    if (cell.bang || cell.jip) {
        bodyHtml += '<div class="bg-orange-50 p-4 rounded-xl border-2 border-orange-200">';
        bodyHtml += '<div class="text-xs text-gray-600 mb-2">배차 차량</div>';
        if (cell.bang) bodyHtml += `<div class="font-bold text-gray-800">🚛 ${cell.bang}</div>`;
        if (cell.jip) bodyHtml += `<div class="font-bold text-gray-800">🚜 ${cell.jip}</div>`;
        bodyHtml += '</div>';
    }

    if (cell.contact) {
        bodyHtml += `
            <div class="bg-pink-50 p-4 rounded-xl border-2 border-pink-200">
                <div class="text-xs text-gray-600 mb-1">연락처</div>
                <div class="font-bold text-gray-800">📞 ${cell.contact}</div>
            </div>
        `;
    }

    if (cell.notes) {
        bodyHtml += `
            <div class="bg-amber-50 p-4 rounded-xl border-2 border-amber-200">
                <div class="text-xs text-gray-600 mb-1">특이사항</div>
                <div class="font-bold text-gray-800">📝 ${cell.notes}</div>
            </div>
        `;
    }

    if (cell.writer) {
        bodyHtml += `
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                <div class="text-xs text-gray-500">
                    작성자: ${cell.writer}
                    ${cell.timestamp ? ` | ${new Date(cell.timestamp).toLocaleString('ko-KR')}` : ''}
                </div>
            </div>
        `;
    }

    bodyHtml += '</div>';
    body.innerHTML = bodyHtml;

    focusView.classList.remove('hidden');
    document.body.classList.add('modal-open');

    logAccess('Open Cell Focus', `${date} Row${row} Col${col}`);
}

function closeFocusView() {
    const focusView = document.getElementById('focusView');
    if (focusView) {
        focusView.classList.add('hidden');
        document.body.classList.remove('modal-open');
    }
}

// ==================== 피벗 입력 모달 ====================
function openPivotModalForDate() {
    const dateInput = document.getElementById('specificDate');
    if (!dateInput || !dateInput.value) {
        showToast('날짜를 선택해주세요');
        return;
    }

    const selectedDate = dateInput.value;
    const weekStart = getWeekStartDate(new Date(selectedDate));

    if (weekStart !== currentWeekStart) {
        currentWeekStart = weekStart;
        updateWeekDisplay();
        loadAndRenderWeek();
    }

    const start = new Date(weekStart);
    const target = new Date(selectedDate);
    const daysDiff = Math.floor((target - start) / (1000 * 60 * 60 * 24));

    if (daysDiff >= 0 && daysDiff < 7) {
        openPivotModal(0, daysDiff, selectedDate);
    }
}

function openPivotModal(row, col, date) {
    currentRow = row;
    currentCol = col;
    syncState(currentWeekStart, row, col);

    const modal = document.getElementById('pivotModal');
    if (!modal) return;

    document.getElementById('pivotDate').value = date;
    pivotSelection.date = date;

    getWeekReport(currentWeekStart).then(report => {
        const cell = report.rows[row][date] || {};

        document.getElementById('pivotCompany').value = cell.company || '';
        document.getElementById('pivotLoading').value = cell.loading || '';
        document.getElementById('pivotTimeInput').value = cell.time || '';
        document.getElementById('pivotContact').value = cell.contact || '';
        document.getElementById('pivotNotes').value = cell.notes || '';
        document.getElementById('pivotStatus').value = cell.status || 'SCHEDULED';

        pivotSelection = {
            company: cell.company || '',
            loading: cell.loading || '',
            time: cell.time || '',
            bang: cell.bang || '',
            jip: cell.jip || '',
            contact: cell.contact || '',
            notes: cell.notes || '',
            date: date,
            status: cell.status || 'SCHEDULED'
        };

        renderCompanyChips();
        renderLoadingChips();
        updatePivotPreview();
    });

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.classList.add('modal-open');

    logAccess('Open Pivot Modal', `${date} Row${row} Col${col}`);
}

function closePivotModal() {
    const modal = document.getElementById('pivotModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-open');
    }

    document.getElementById('pivotCompany').value = '';
    document.getElementById('pivotLoading').value = '';
    document.getElementById('pivotTimeInput').value = '';
    document.getElementById('pivotContact').value = '';
    document.getElementById('pivotNotes').value = '';
    document.getElementById('pivotStatus').value = 'SCHEDULED';
    document.getElementById('bangSelect').value = '';
    document.getElementById('jipSelect').value = '';

    pivotSelection = {
        company: '', loading: '', time: '', bang: '', jip: '',
        contact: '', notes: '', date: '', status: 'SCHEDULED'
    };

    updatePivotPreview();
}

// ==================== 피벗 데이터 저장 ====================
async function applyAndSave() {
    const company = document.getElementById('pivotCompany').value.trim();
    const loading = document.getElementById('pivotLoading').value.trim();
    const time = document.getElementById('pivotTimeInput').value.trim();
    const contact = document.getElementById('pivotContact').value.trim();
    const notes = document.getElementById('pivotNotes').value.trim();
    const status = document.getElementById('pivotStatus').value;
    const date = document.getElementById('pivotDate').value;

    if (!company) {
        showToast('업체명은 필수 입력 사항입니다');
        return;
    }

    if (!date) {
        showToast('날짜를 선택해주세요');
        return;
    }

    const weekStart = getWeekStartDate(new Date(date));

    try {
        const report = await getWeekReport(weekStart);

        if (!report.rows[currentRow]) {
            report.rows[currentRow] = {};
        }

        let bang = '';
        let jip = '';

        if (bangMode === 'single') {
            bang = document.getElementById('bangSelect').value;
        } else {
            const min = parseInt(document.getElementById('bangMin').value) || 0;
            const max = parseInt(document.getElementById('bangMax').value) || 0;
            if (min > 0 && max > 0) {
                bang = `방 ${min}~${max}대`;
            } else if (min > 0) {
                bang = `방 ${min}대`;
            }
        }

        if (jipMode === 'single') {
            jip = document.getElementById('jipSelect').value;
        } else {
            const min = parseInt(document.getElementById('jipMin').value) || 0;
            const max = parseInt(document.getElementById('jipMax').value) || 0;
            if (min > 0 && max > 0) {
                jip = `집 ${min}~${max}대`;
            } else if (min > 0) {
                jip = `집 ${min}대`;
            }
        }

        report.rows[currentRow][date] = {
            company: company,
            loading: loading,
            time: time,
            bang: bang,
            jip: jip,
            contact: contact,
            notes: notes,
            status: status,
            writer: writer.name,
            timestamp: new Date().toISOString()
        };

        await saveWeekReport(weekStart, report.rows);

        if (weekStart === currentWeekStart) {
            await loadAndRenderWeek();
        }

        showToast('저장되었습니다');
        closePivotModal();

        logAccess('Save Pivot Data', `${date} ${company}`);
    } catch (error) {
        console.error('❌ 저장 실패:', error);
        logError('Save Pivot Data', error);
        showToast('저장 실패');
    }
}

// ==================== 업체/상차지 관리 ====================
function saveCompanyToList() {
    const input = document.getElementById('pivotCompany');
    const value = input.value.trim();

    if (!value) {
        showToast('업체명을 입력해주세요');
        return;
    }

    if (COMPANIES.includes(value)) {
        showToast('이미 목록에 있습니다');
        return;
    }

    if (COMPANIES.length >= MAX_COMPANIES) {
        COMPANIES.shift();
    }

    COMPANIES.push(value);
    localStorage.setItem('companyList', JSON.stringify(COMPANIES));
    renderCompanyChips();
    showToast(`"${value}" 저장됨`);
    logAccess('Save Company', value);
}

function saveLoadingToList() {
    const input = document.getElementById('pivotLoading');
    const value = input.value.trim();

    if (!value) {
        showToast('상차지를 입력해주세요');
        return;
    }

    if (LOADINGS.includes(value)) {
        showToast('이미 목록에 있습니다');
        return;
    }

    if (LOADINGS.length >= MAX_LOADINGS) {
        LOADINGS.shift();
    }

    LOADINGS.push(value);
    localStorage.setItem('loadingList', JSON.stringify(LOADINGS));
    renderLoadingChips();
    showToast(`"${value}" 저장됨`);
    logAccess('Save Loading', value);
}

function renderCompanyChips() {
    const container = document.getElementById('companiesChips');
    if (!container) return;

    container.innerHTML = '';

    COMPANIES.forEach((company, index) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `
            ${company}
            <button onclick="removeCompany(${index}); event.stopPropagation();">×</button>
        `;
        chip.onclick = () => {
            document.getElementById('pivotCompany').value = company;
            pivotSelection.company = company;
            updatePivotPreview();
        };
        container.appendChild(chip);
    });
}

function renderLoadingChips() {
    const container = document.getElementById('loadingsChips');
    if (!container) return;

    container.innerHTML = '';

    LOADINGS.forEach((loading, index) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `
            ${loading}
            <button onclick="removeLoading(${index}); event.stopPropagation();">×</button>
        `;
        chip.onclick = () => {
            document.getElementById('pivotLoading').value = loading;
            pivotSelection.loading = loading;
            updatePivotPreview();
        };
        container.appendChild(chip);
    });
}

function removeCompany(index) {
    COMPANIES.splice(index, 1);
    localStorage.setItem('companyList', JSON.stringify(COMPANIES));
    renderCompanyChips();
    showToast('삭제되었습니다');
}

function removeLoading(index) {
    LOADINGS.splice(index, 1);
    localStorage.setItem('loadingList', JSON.stringify(LOADINGS));
    renderLoadingChips();
    showToast('삭제되었습니다');
}

// ==================== 차량 설정 ====================
function showVehicleModal() {
    const modal = document.getElementById('vehicleModal');
    if (!modal) return;

    const bangCount = parseInt(localStorage.getItem('bangCount') || '5');
    const jipCount = parseInt(localStorage.getItem('jipCount') || '3');

    document.getElementById('bangCountInput').value = bangCount;
    document.getElementById('jipCountInput').value = jipCount;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.classList.add('modal-open');

    logAccess('Open Vehicle Modal');
}

function closeVehicleModal() {
    const modal = document.getElementById('vehicleModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-open');
    }
}

function saveVehicleCount() {
    const bangCount = parseInt(document.getElementById('bangCountInput').value);
    const jipCount = parseInt(document.getElementById('jipCountInput').value);

    if (bangCount < 1 || bangCount > 20) {
        showToast('방통차는 1~20대 사이로 설정해주세요');
        return;
    }

    if (jipCount < 1 || jipCount > 10) {
        showToast('집게차는 1~10대 사이로 설정해주세요');
        return;
    }

    localStorage.setItem('bangCount', bangCount);
    localStorage.setItem('jipCount', jipCount);

    populateVehicleSelects();
    showToast('차량 대수가 저장되었습니다');
    closeVehicleModal();

    logAccess('Save Vehicle Count', `방${bangCount} 집${jipCount}`);
}

function populateVehicleSelects() {
    const bangCount = parseInt(localStorage.getItem('bangCount') || '5');
    const jipCount = parseInt(localStorage.getItem('jipCount') || '3');

    const bangSelect = document.getElementById('bangSelect');
    const jipSelect = document.getElementById('jipSelect');

    if (bangSelect) {
        bangSelect.innerHTML = '<option value="">선택안함</option>';
        for (let i = 1; i <= bangCount; i++) {
            bangSelect.innerHTML += `<option value="방 ${i}대">방 ${i}대</option>`;
        }
    }

    if (jipSelect) {
        jipSelect.innerHTML = '<option value="">선택안함</option>';
        for (let i = 1; i <= jipCount; i++) {
            jipSelect.innerHTML += `<option value="집 ${i}대">집 ${i}대</option>`;
        }
    }
}

// ==================== 검색 기능 ====================
function showSearchModal() {
    const modal = document.getElementById('searchModal');
    if (!modal) return;

    const today = new Date();
    const monthAgo = new Date(today);
    monthAgo.setMonth(monthAgo.getMonth() - 1);

    document.getElementById('searchStartDate').value = monthAgo.toISOString().split('T')[0];
    document.getElementById('searchEndDate').value = today.toISOString().split('T')[0];
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.classList.add('modal-open');

    logAccess('Open Search Modal');
}

function closeSearchModal() {
    const modal = document.getElementById('searchModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-open');
    }
}

async function performSearch() {
    const query = document.getElementById('searchInput').value.trim().toLowerCase();
    const startDate = document.getElementById('searchStartDate').value;
    const endDate = document.getElementById('searchEndDate').value;
    const resultsDiv = document.getElementById('searchResults');

    if (!resultsDiv) return;

    if (!query && !startDate && !endDate) {
        resultsDiv.innerHTML = '<div class="text-gray-400 text-center py-4">검색어 또는 날짜를 입력해주세요</div>';
        return;
    }

    try {
        const allReports = await getAllReports();
        const results = [];

        for (const report of allReports) {
            for (let r = 0; r < report.rows.length; r++) {
                for (const date in report.rows[r]) {
                    const cell = report.rows[r][date];

                    if (startDate && date < startDate) continue;
                    if (endDate && date > endDate) continue;

                    const searchText = [
                        cell.company,
                        cell.loading,
                        cell.time,
                        cell.bang,
                        cell.jip,
                        cell.contact,
                        cell.notes,
                        cell.writer
                    ].join(' ').toLowerCase();

                    if (!query || searchText.includes(query)) {
                        if (cell.company || cell.loading || cell.time) {
                            results.push({ date, cell, row: r });
                        }
                    }
                }
            }
        }

        results.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (results.length === 0) {
            resultsDiv.innerHTML = '<div class="text-gray-400 text-center py-4">검색 결과가 없습니다</div>';
            return;
        }

        resultsDiv.innerHTML = results.map(result => {
            const { date, cell } = result;
            const statusInfo = STATUS_MAP[cell.status] || STATUS_MAP.SCHEDULED;

            return `
                <div class="p-4 border-2 ${statusInfo.class} rounded-xl cursor-pointer hover:shadow-lg transition"
                     onclick="jumpToDate('${date}')">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-black text-gray-800">${cell.company}</div>
                        <div class="text-xs px-2 py-1 rounded-full ${statusInfo.color}">${statusInfo.name}</div>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div>📅 ${formatDateDisplay(date)}</div>
                        ${cell.loading ? `<div>📍 ${cell.loading}</div>` : ''}
                        ${cell.time ? `<div>🕐 ${cell.time}</div>` : ''}
                        ${cell.bang ? `<div>🚛 ${cell.bang}</div>` : ''}
                        ${cell.jip ? `<div>🚜 ${cell.jip}</div>` : ''}
                        ${cell.writer ? `<div class="text-xs text-gray-500 mt-2">✍️ ${cell.writer}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');

        logAccess('Perform Search', query);
    } catch (error) {
        console.error('❌ 검색 실패:', error);
        logError('Perform Search', error);
        resultsDiv.innerHTML = '<div class="text-red-500 text-center py-4">검색 중 오류가 발생했습니다</div>';
    }
}

function jumpToDate(date) {
    const weekStart = getWeekStartDate(new Date(date));
    currentWeekStart = weekStart;
    updateWeekDisplay();
    loadAndRenderWeek();
    closeSearchModal();
    showPage('view');
    showToast(`${formatDateDisplay(date)}로 이동했습니다`);
    logAccess('Jump To Date', date);
}

// ==================== 내보내기 기능 ====================
function showExportModal() {
    const modal = document.getElementById('exportModal');
    if (!modal) return;

    const today = new Date();
    const monthAgo = new Date(today);
    monthAgo.setMonth(monthAgo.getMonth() - 1);

    document.getElementById('exportStartDate').value = monthAgo.toISOString().split('T')[0];
    document.getElementById('exportEndDate').value = today.toISOString().split('T')[0];

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.classList.add('modal-open');

    logAccess('Open Export Modal');
}

function closeExportModal() {
    const modal = document.getElementById('exportModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-open');
    }
}

async function exportToCSV() {
    const startDate = document.getElementById('exportStartDate').value;
    const endDate = document.getElementById('exportEndDate').value;

    if (!startDate || !endDate) {
        showToast('시작일과 종료일을 선택해주세요');
        return;
    }

    try {
        const allReports = await getAllReports();
        const csvRows = [];

        csvRows.push(['날짜', '업체명', '상차지', '시간', '방통차', '집게차', '연락처', '특이사항', '상태', '작성자', '작성일시'].join(','));

        for (const report of allReports) {
            for (let r = 0; r < report.rows.length; r++) {
                for (const date in report.rows[r]) {
                    if (date < startDate || date > endDate) continue;

                    const cell = report.rows[r][date];
                    if (!cell.company && !cell.loading && !cell.time) continue;

                    const statusName = STATUS_MAP[cell.status]?.name || '예정';
                    const timestamp = cell.timestamp ? new Date(cell.timestamp).toLocaleString('ko-KR') : '';

                    csvRows.push([
                        date,
                        cell.company || '',
                        cell.loading || '',
                        cell.time || '',
                        cell.bang || '',
                        cell.jip || '',
                        cell.contact || '',
                        cell.notes || '',
                        statusName,
                        cell.writer || '',
                        timestamp
                    ].map(v => `"${v}"`).join(','));
                }
            }
        }

        const csvContent = '\uFEFF' + csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `배차현황_${startDate}_${endDate}.csv`;
        link.click();

        showToast('CSV 파일이 다운로드되었습니다');
        logAccess('Export CSV', `${startDate} ~ ${endDate}`);
    } catch (error) {
        console.error('❌ CSV 내보내기 실패:', error);
        logError('Export CSV', error);
        showToast('내보내기 실패');
    }
}

async function exportToExcel() {
    const startDate = document.getElementById('exportStartDate').value;
    const endDate = document.getElementById('exportEndDate').value;

    if (!startDate || !endDate) {
        showToast('시작일과 종료일을 선택해주세요');
        return;
    }

    try {
        const allReports = await getAllReports();
        const data = [];

        data.push(['날짜', '업체명', '상차지', '시간', '방통차', '집게차', '연락처', '특이사항', '상태', '작성자', '작성일시']);

        for (const report of allReports) {
            for (let r = 0; r < report.rows.length; r++) {
                for (const date in report.rows[r]) {
                    if (date < startDate || date > endDate) continue;

                    const cell = report.rows[r][date];
                    if (!cell.company && !cell.loading && !cell.time) continue;

                    const statusName = STATUS_MAP[cell.status]?.name || '예정';
                    const timestamp = cell.timestamp ? new Date(cell.timestamp).toLocaleString('ko-KR') : '';

                    data.push([
                        date,
                        cell.company || '',
                        cell.loading || '',
                        cell.time || '',
                        cell.bang || '',
                        cell.jip || '',
                        cell.contact || '',
                        cell.notes || '',
                        statusName,
                        cell.writer || '',
                        timestamp
                    ]);
                }
            }
        }

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '배차현황');

        XLSX.writeFile(wb, `배차현황_${startDate}_${endDate}.xlsx`);

        showToast('Excel 파일이 다운로드되었습니다');
        logAccess('Export Excel', `${startDate} ~ ${endDate}`);
    } catch (error) {
        console.error('❌ Excel 내보내기 실패:', error);
        logError('Export Excel', error);
        showToast('내보내기 실패');
    }
}

// ==================== 작성자 인증 ====================
function showWriterModal() {
    const modal = document.getElementById('writerModal');
    if (!modal) return;

    document.getElementById('writerNameInput').value = writer.name === '미인증' ? '' : writer.name;
    document.getElementById('writerPassInput').value = '';

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.classList.add('modal-open');

    logAccess('Open Writer Modal');
}

function closeWriterModal() {
    const modal = document.getElementById('writerModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('modal-open');
    }
}

function saveWriter() {
    const name = document.getElementById('writerNameInput').value.trim();
    const pin = document.getElementById('writerPassInput').value.trim();

    if (!name) {
        showToast('이름을 입력해주세요');
        return;
    }

    if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
        showToast('4자리 숫자 비밀번호를 입력해주세요');
        return;
    }

    writer = { name, pin };
    localStorage.setItem('writerName', name);
    localStorage.setItem('writerPin', pin);

    document.getElementById('writerName').textContent = name;
    if (document.getElementById('writerNameMobile')) {
        document.getElementById('writerNameMobile').textContent = name;
    }

    showToast(`${name}님 인증되었습니다`);
    closeWriterModal();

    logAccess('Writer Login', name);
}

function logout() {
    writer = { name: '미인증', pin: '' };
    localStorage.removeItem('writerName');
    localStorage.removeItem('writerPin');

    document.getElementById('writerName').textContent = '미인증';
    if (document.getElementById('writerNameMobile')) {
        document.getElementById('writerNameMobile').textContent = '미인증';
    }

    showToast('로그아웃되었습니다');
    closeWriterModal();

    logAccess('Writer Logout');
}

function loadWriter() {
    const savedName = localStorage.getItem('writerName');
    const savedPin = localStorage.getItem('writerPin');

    if (savedName && savedPin) {
        writer = { name: savedName, pin: savedPin };
        document.getElementById('writerName').textContent = savedName;
        if (document.getElementById('writerNameMobile')) {
            document.getElementById('writerNameMobile').textContent = savedName;
        }
    }
}

// ==================== 접속 로그 ====================
function showAccessLog() {
    getAccessLogs().then(logs => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-60 modal-backdrop flex items-center justify-center z-50 p-3';
        modal.innerHTML = `
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
                <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-4 md:p-6 rounded-t-3xl z-10">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl md:text-2xl font-black">접속 로그</h3>
                        <button onclick="this.closest('.modal-backdrop').remove(); document.body.classList.remove('modal-open');"
                                class="text-2xl md:text-3xl hover:text-gray-200 transition">×</button>
                    </div>
                </div>
                <div class="p-4 md:p-6">
                    ${logs.length === 0 ?
                        '<div class="text-gray-400 text-center py-8">로그가 없습니다</div>' :
                        logs.map(log => `
                            <div class="p-3 mb-2 bg-gray-50 rounded-xl border border-gray-200">
                                <div class="flex justify-between items-start">
                                    <div class="font-bold text-gray-800">${log.action}</div>
                                    <div class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString('ko-KR')}</div>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">
                                    작성자: ${log.writer}
                                    ${log.details ? ` | ${log.details}` : ''}
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        document.body.classList.add('modal-open');

        logAccess('View Access Log');
    }).catch(error => {
        console.error('❌ 로그 조회 실패:', error);
        showToast('로그 조회 실패');
    });
}

// ==================== 버그 리포트 ====================
function showBugReport() {
    getErrorLogs().then(logs => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-60 modal-backdrop flex items-center justify-center z-50 p-3';
        modal.innerHTML = `
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
                <div class="sticky top-0 bg-gradient-to-r from-red-600 to-pink-700 text-white p-4 md:p-6 rounded-t-3xl z-10">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl md:text-2xl font-black">오류 로그</h3>
                        <button onclick="this.closest('.modal-backdrop').remove(); document.body.classList.remove('modal-open');"
                                class="text-2xl md:text-3xl hover:text-gray-200 transition">×</button>
                    </div>
                </div>
                <div class="p-4 md:p-6">
                    ${logs.length === 0 ?
                        '<div class="text-gray-400 text-center py-8">오류 로그가 없습니다</div>' :
                        logs.map(log => `
                            <div class="p-3 mb-2 bg-red-50 rounded-xl border-2 border-red-200">
                                <div class="flex justify-between items-start">
                                    <div class="font-bold text-red-800">${log.action}</div>
                                    <div class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString('ko-KR')}</div>
                                </div>
                                <div class="text-sm text-gray-700 mt-2 font-mono bg-white p-2 rounded border">
                                    ${log.error}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">작성자: ${log.writer}</div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        document.body.classList.add('modal-open');

        logAccess('View Error Log');
    }).catch(error => {
        console.error('❌ 오류 로그 조회 실패:', error);
        showToast('오류 로그 조회 실패');
    });
}

// ==================== 상태 동기화 ====================
function syncState(weekStart, row, col) {
    currentWeekStart = weekStart;
    currentRow = row;
    currentCol = col;

    if (typeof console !== 'undefined') {
        console.log(`[✓ State Synced] Week: ${weekStart}, Row: ${row}, Col: ${col}`);
    }
}

// ==================== 방통차/집게차 모드 설정 ====================
function setBangMode(mode) {
    bangMode = mode;
    document.getElementById('bangModeSingle').className = mode === 'single'
        ? 'flex-1 py-2 px-3 bg-orange-200 border-2 border-orange-400 rounded-lg text-xs font-bold'
        : 'flex-1 py-2 px-3 bg-white border-2 border-orange-300 rounded-lg text-xs font-bold';
    document.getElementById('bangModeRange').className = mode === 'range'
        ? 'flex-1 py-2 px-3 bg-orange-200 border-2 border-orange-400 rounded-lg text-xs font-bold'
        : 'flex-1 py-2 px-3 bg-white border-2 border-orange-300 rounded-lg text-xs font-bold';

    document.getElementById('bangSingleInput').classList.toggle('hidden', mode === 'range');
    document.getElementById('bangRangeInput').classList.toggle('hidden', mode === 'single');

    if (mode === 'range') {
        document.getElementById('bangSelect').value = '';
        pivotSelection.bang = '';
    } else {
        document.getElementById('bangMin').value = '';
        document.getElementById('bangMax').value = '';
    }
    updatePivotPreview();
}

function setJipMode(mode) {
    jipMode = mode;
    document.getElementById('jipModeSingle').className = mode === 'single'
        ? 'flex-1 py-2 px-3 bg-cyan-200 border-2 border-cyan-400 rounded-lg text-xs font-bold'
        : 'flex-1 py-2 px-3 bg-white border-2 border-cyan-300 rounded-lg text-xs font-bold';
    document.getElementById('jipModeRange').className = mode === 'range'
        ? 'flex-1 py-2 px-3 bg-cyan-200 border-2 border-cyan-400 rounded-lg text-xs font-bold'
        : 'flex-1 py-2 px-3 bg-white border-2 border-cyan-300 rounded-lg text-xs font-bold';

    document.getElementById('jipSingleInput').classList.toggle('hidden', mode === 'range');
    document.getElementById('jipRangeInput').classList.toggle('hidden', mode === 'single');

    if (mode === 'range') {
        document.getElementById('jipSelect').value = '';
        pivotSelection.jip = '';
    } else {
        document.getElementById('jipMin').value = '';
        document.getElementById('jipMax').value = '';
    }
    updatePivotPreview();
}

function updateBangRange() {
    const min = parseInt(document.getElementById('bangMin').value) || 0;
    const max = parseInt(document.getElementById('bangMax').value) || 0;

    if (min > 0 && max > 0) {
        if (max >= min) {
            pivotSelection.bang = `방 ${min}~${max}대`;
        } else {
            pivotSelection.bang = '';
            showToast('⚠️ 최대값은 최소값보다 크거나 같아야 합니다');
        }
    } else if (min > 0) {
        pivotSelection.bang = `방 ${min}대`;
    } else {
        pivotSelection.bang = '';
    }
    updatePivotPreview();
}

function updateJipRange() {
    const min = parseInt(document.getElementById('jipMin').value) || 0;
    const max = parseInt(document.getElementById('jipMax').value) || 0;

    if (min > 0 && max > 0) {
        if (max >= min) {
            pivotSelection.jip = `집 ${min}~${max}대`;
        } else {
            pivotSelection.jip = '';
            showToast('⚠️ 최대값은 최소값보다 크거나 같아야 합니다');
        }
    } else if (min > 0) {
        pivotSelection.jip = `집 ${min}대`;
    } else {
        pivotSelection.jip = '';
    }
    updatePivotPreview();
}

// ==================== 헤더 토글 ====================
function toggleHeader() {
    const headerContent = document.getElementById('headerContent');
    const toggleIcon = document.getElementById('headerToggleIcon');

    headerContent.classList.toggle('compact');
    if (toggleIcon) {
        toggleIcon.style.transform = headerContent.classList.contains('compact')
            ? 'rotate(180deg)'
            : 'rotate(0deg)';
    }
}

function handleHeaderScroll() {
    if (window.innerWidth >= 768) return;

    const currentScrollY = window.scrollY;
    const headerContent = document.getElementById('headerContent');

    if (!headerContent) return;

    if (currentScrollY > lastScrollY && currentScrollY > 100) {
        headerContent.classList.add('compact');
    } else if (currentScrollY < lastScrollY || currentScrollY < 50) {
        headerContent.classList.remove('compact');
    }

    lastScrollY = currentScrollY;
}

// ==================== 드로어 메뉴 ====================
function openDrawer() {
    document.getElementById('mobileDrawer').classList.add('open');
    document.getElementById('drawerOverlay').classList.add('show');
    document.body.classList.add('drawer-open');
}

function closeDrawer() {
    document.getElementById('mobileDrawer').classList.remove('open');
    document.getElementById('drawerOverlay').classList.remove('show');
    document.body.classList.remove('drawer-open');
}

// ==================== 토스트 알림 ====================
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.remove('hidden');

    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

// ==================== 피벗 미리보기 ====================
function updatePivotPreview() {
    const preview = document.getElementById('previewContent');
    if (!preview) return;

    pivotSelection.company = document.getElementById('pivotCompany').value.trim();
    pivotSelection.loading = document.getElementById('pivotLoading').value.trim();
    pivotSelection.time = document.getElementById('pivotTimeInput').value.trim();

    let html = '';
    if (pivotSelection.company) html += `<div><strong>업체:</strong> ${pivotSelection.company}</div>`;
    if (pivotSelection.loading) html += `<div><strong>상차지:</strong> ${pivotSelection.loading}</div>`;
    if (pivotSelection.time) html += `<div><strong>시간:</strong> ${pivotSelection.time}</div>`;
    if (pivotSelection.bang) html += `<div><strong>방통차:</strong> ${pivotSelection.bang}</div>`;
    if (pivotSelection.jip) html += `<div><strong>집게차:</strong> ${pivotSelection.jip}</div>`;
    if (pivotSelection.contact) html += `<div><strong>연락처:</strong> ${pivotSelection.contact}</div>`;
    if (pivotSelection.notes) html += `<div><strong>특이사항:</strong> ${pivotSelection.notes}</div>`;

    preview.innerHTML = html || '<div class="text-gray-400">입력된 정보가 없습니다</div>';
}

function selectPivot(field, value) {
    pivotSelection[field] = value;
    updatePivotPreview();
}

// ==================== 스크롤 이벤트 ====================
window.addEventListener('scroll', () => {
    if (!scrollTicking) {
        window.requestAnimationFrame(() => {
            handleHeaderScroll();
            scrollTicking = false;
        });
        scrollTicking = true;
    }
});

// ==================== PWA 설치 프롬프트 ====================
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    const installDismissed = localStorage.getItem('pwa-install-dismissed');
    if (installDismissed) {
        return;
    }

    setTimeout(() => {
        showInstallPrompt();
    }, 3000);
});

function showInstallPrompt() {
    const toast = document.getElementById('toast');
    toast.innerHTML = `
        <div class="flex items-center justify-between gap-3">
            <div>
                <div class="font-black">📱 앱으로 설치</div>
                <div class="text-xs opacity-90">홈 화면에 추가하여 빠르게 접근하세요</div>
            </div>
            <div class="flex gap-2">
                <button onclick="installPWA()" class="px-3 py-1 bg-white text-green-600 rounded-lg text-sm font-bold">
                    설치
                </button>
                <button onclick="dismissInstall()" class="px-3 py-1 bg-green-700 text-white rounded-lg text-sm">
                    닫기
                </button>
            </div>
        </div>
    `;
    toast.classList.remove('hidden');
}

function installPWA() {
    if (!deferredPrompt) {
        return;
    }

    deferredPrompt.prompt();

    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            console.log('✅ PWA 설치됨');
        } else {
            console.log('❌ PWA 설치 거부됨');
        }
        deferredPrompt = null;
        document.getElementById('toast').classList.add('hidden');
    });
}

function dismissInstall() {
    document.getElementById('toast').classList.add('hidden');
    localStorage.setItem('pwa-install-dismissed', 'true');
}

window.addEventListener('appinstalled', () => {
    console.log('✅ PWA가 설치되었습니다!');
    deferredPrompt = null;
});

// ==================== Service Worker 등록 ====================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
                console.log('✅ Service Worker registered:', registration.scope);
            })
            .catch((error) => {
                console.log('❌ Service Worker registration failed:', error);
            });
    });
}

// ==================== 초기화 ====================
window.addEventListener('DOMContentLoaded', async () => {
    console.log('📱 모바일 브라우저 최적화 적용됨');

    try {
        await initDB();

        loadWriter();

        currentWeekStart = getWeekStartDate(new Date());
        updateWeekDisplay();

        populateVehicleSelects();

        const today = new Date();
        document.getElementById('specificDate').value = today.toISOString().split('T')[0];

        await loadAndRenderWeek();

        console.log('✅ 애플리케이션 초기화 완료');
        logAccess('App Started');
    } catch (error) {
        console.error('❌ 초기화 실패:', error);
        logError('App Initialization', error);
        showToast('초기화 중 오류가 발생했습니다');
    }
});
    </script>
</body>
</html>
